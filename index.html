<!DOCTYPE html>
<html>
<head>
    <title>Брутфорс Плейфера со словарём</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        textarea, button, pre, input {
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            box-sizing: border-box;
        }
        #output {
            white-space: pre-wrap;
            background: #f5f5f5;
            padding: 10px;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            color: #666;
            font-size: 0.9em;
        }
        .file-input {
            display: none;
        }
        .file-label {
            display: inline-block;
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            text-align: center;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        button {
            padding: 10px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background: #cccccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Брутфорс шифра Плейфера</h1>
        
        <label for="ciphertext">Шифротекст (только буквы A-Z, без пробелов):</label>
        <input type="text" id="ciphertext" value="DMQPQSPSX">
        
        <div class="controls">
            <label for="dictionaryFile" class="file-label">Загрузить словарь (.txt)</label>
            <input type="file" id="dictionaryFile" class="file-input" accept=".txt">
            <button id="startButton">Начать брутфорс</button>
            <button id="stopButton" disabled>Остановить</button>
        </div>
        
        <div class="status">Загружено слов: <span id="wordCount">0</span></div>
        <div class="status">Проверено: <span id="checkedCount">0</span></div>
        <div class="status">Скорость: <span id="speed">0</span> слов/сек</div>
        
        <label for="output">Результаты:</label>
        <pre id="output">Здесь будут появляться найденные ключи...</pre>
    </div>

    <script>
        // Глобальные переменные
        let dictionary = [];
        let workers = [];
        let isRunning = false;
        let checkedWords = 0;
        let lastUpdate = 0;
        let speed = 0;
        
        // Загрузка словаря из файла
        document.getElementById('dictionaryFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                dictionary = content.toUpperCase()
                    .split('\n')
                    .map(word => word.trim().replace(/[^A-Z]/g, ''))
                    .filter(word => word.length >= 4 && word.length <= 12);
                
                document.getElementById('wordCount').textContent = dictionary.length;
                document.getElementById('output').textContent = `Загружен словарь (${dictionary.length} слов). Можно начинать брутфорс.`;
            };
            reader.readAsText(file);
        });
        
        // Функция для создания матрицы Плейфера
        function buildMatrix(key) {
            const matrix = [[], [], [], [], []];
            const used = new Set();
            let row = 0, col = 0;
            
            // Добавляем буквы ключа (I и J объединены)
            for (const char of key) {
                const c = char === 'J' ? 'I' : char;
                if (!used.has(c)) {
                    matrix[row][col] = c;
                    used.add(c);
                    col++;
                    if (col === 5) {
                        col = 0;
                        row++;
                    }
                }
            }
            
            // Добавляем оставшиеся буквы алфавита
            for (let i = 0; i < 26; i++) {
                const c = String.fromCharCode(65 + (i >= 9 ? i + 1 : i)); // Пропускаем J
                if (!used.has(c)) {
                    matrix[row][col] = c;
                    col++;
                    if (col === 5) {
                        col = 0;
                        row++;
                    }
                }
            }
            
            return matrix;
        }
        
        // Функция дешифровки биграммы
        function decryptBigram(a, b, matrix) {
            let aRow, aCol, bRow, bCol;
            
            // Находим позиции букв в матрице
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    if (matrix[row][col] === a) {
                        aRow = row;
                        aCol = col;
                    }
                    if (matrix[row][col] === b) {
                        bRow = row;
                        bCol = col;
                    }
                }
            }
            
            // Правила дешифровки
            if (aRow === bRow) {
                return [
                    matrix[aRow][(aCol - 1 + 5) % 5],
                    matrix[bRow][(bCol - 1 + 5) % 5]
                ];
            } else if (aCol === bCol) {
                return [
                    matrix[(aRow - 1 + 5) % 5][aCol],
                    matrix[(bRow - 1 + 5) % 5][bCol]
                ];
            } else {
                return [
                    matrix[aRow][bCol],
                    matrix[bRow][aCol]
                ];
            }
        }
        
        // Основная функция дешифровки
        function decryptPlayfair(ciphertext, key) {
            const matrix = buildMatrix(key);
            let plaintext = '';
            
            // Разбиваем на биграммы и дешифруем
            for (let i = 0; i < ciphertext.length; i += 2) {
                const a = ciphertext[i];
                const b = ciphertext[i+1];
                const [p1, p2] = decryptBigram(a, b, matrix);
                plaintext += p1 + p2;
            }
            
            return plaintext;
        }
        
        // Проверка на осмысленный текст
        function isMeaningful(text) {
            const commonBigrams = ['TH', 'HE', 'IN', 'ER', 'AN', 'RE', 'ES', 'ON'];
            const commonWords = ['THE', 'AND', 'ING', 'HER', 'HAT', 'HIS', 'ERE'];
            
            // Проверяем частые биграммы
            for (let i = 0; i < text.length - 1; i++) {
                const bigram = text.substr(i, 2);
                if (commonBigrams.includes(bigram)) {
                    return true;
                }
            }
            
            // Проверяем частые слова
            for (const word of commonWords) {
                if (text.includes(word)) {
                    return true;
                }
            }
            
            return false;
        }
        
        // Запуск брутфорса
        document.getElementById('startButton').addEventListener('click', function() {
            if (isRunning) return;
            if (dictionary.length === 0) {
                alert('Сначала загрузите словарь!');
                return;
            }
            
            const ciphertext = document.getElementById('ciphertext').value
                .toUpperCase()
                .replace(/[^A-Z]/g, '');
            
            if (ciphertext.length === 0 || ciphertext.length % 2 !== 0) {
                alert('Шифротекст должен содержать четное количество букв A-Z!');
                return;
            }
            
            isRunning = true;
            checkedWords = 0;
            lastUpdate = performance.now();
            document.getElementById('startButton').disabled = true;
            document.getElementById('stopButton').disabled = false;
            document.getElementById('output').textContent = 'Начался брутфорс...\n';
            
            // Создаем Web Worker для брутфорса
            const workerCode = `
                ${buildMatrix.toString()}
                ${decryptBigram.toString()}
                ${decryptPlayfair.toString()}
                ${isMeaningful.toString()}
                
                onmessage = function(e) {
                    const [ciphertext, words] = e.data;
                    const results = [];
                    
                    for (const key of words) {
                        const plaintext = decryptPlayfair(ciphertext, key);
                        if (isMeaningful(plaintext)) {
                            results.push({ key, plaintext });
                        }
                    }
                    
                    postMessage(results);
                };
            `;
            
            const workerBlob = new Blob([workerCode], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(workerBlob);
            
            // Разделяем словарь на части для параллельной обработки
            const workerCount = navigator.hardwareConcurrency || 4;
            const chunkSize = Math.ceil(dictionary.length / workerCount);
            
            for (let i = 0; i < workerCount; i++) {
                const start = i * chunkSize;
                const end = start + chunkSize;
                const worker = new Worker(workerUrl);
                
                worker.postMessage([ciphertext, dictionary.slice(start, end)]);
                
                worker.onmessage = function(e) {
                    checkedWords += e.data.length;
                    const now = performance.now();
                    
                    // Обновляем статистику каждые 500мс
                    if (now - lastUpdate > 500) {
                        speed = Math.round(checkedWords / ((now - lastUpdate) / 1000));
                        document.getElementById('checkedCount').textContent = checkedWords;
                        document.getElementById('speed').textContent = speed;
                        lastUpdate = now;
                    }
                    
                    // Выводим результаты
                    for (const result of e.data) {
                        const output = document.getElementById('output');
                        output.textContent += \`Найден ключ: \${result.key}\\nТекст: \${result.plaintext}\\n\\n\`;
                        output.scrollTop = output.scrollHeight;
                    }
                };
                
                workers.push(worker);
            }
        });
        
        // Остановка брутфорса
        document.getElementById('stopButton').addEventListener('click', function() {
            if (!isRunning) return;
            
            isRunning = false;
            workers.forEach(worker => worker.terminate());
            workers = [];
            
            document.getElementById('startButton').disabled = false;
            document.getElementById('stopButton').disabled = true;
            document.getElementById('output').textContent += '\nБрутфорс остановлен.\n';
        });
    </script>
</body>
</html>
