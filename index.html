<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vigen√®re Cracker Ultimate</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --accent: #00bcd4;
            --match-bg: #ffeb3b33;
        }
        body {
            font-family: 'Consolas', monospace;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 2rem;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .panel {
            background: #2d2d2d;
            padding: 1.5rem;
            border-radius: 8px;
        }
        textarea, input, button {
            width: 100%;
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: #3d3d3d;
            border: 1px solid #4d4d4d;
            color: var(--text-color);
        }
        .match {
            background: var(--match-bg);
            padding: 2px;
        }
        .progress {
            color: #00bcd4;
            margin: 1rem 0;
        }
        #controls {
            display: flex;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel">
            <h2>Input</h2>
            <textarea id="ciphertext" rows="6">OBKRUOXOGHULBSOLIFBBWFLRVQQPRNGKSSOTWTQSJQSSEKZZWATJKLUDIAWINFBNYPVTTMZFPKWGDKZXTJCDIGKUHUAUEKCAR</textarea>
            <input id="knownText" type="text" value="NORTHEAST" placeholder="Known plaintext">
            <input id="alphabet" type="text" value="KRYPTOSABCDEFGHIJLMNQUVWXZ" placeholder="Alphabet">
            <input id="keyLength" type="number" value="9" min="1" placeholder="Key length">
            <div id="controls">
                <button onclick="start()">Analyze</button>
                <button onclick="stop()" id="stopBtn" disabled>Stop</button>
            </div>
            <div id="progress" class="progress"></div>
        </div>
        <div class="panel">
            <h2>Results</h2>
            <div id="results"></div>
        </div>
    </div>

<script>
let isRunning = false;
let currentPos = 0;

class Vigen√®rePro {
    static decrypt(ciphertext, key, alphabet) {
        const mod = alphabet.length;
        return [...ciphertext].map((c, i) => {
            const keyChar = key[i % key.length];
            const cIdx = alphabet.indexOf(c);
            const kIdx = alphabet.indexOf(keyChar);
            return (cIdx !== -1 && kIdx !== -1) 
                ? alphabet[(cIdx - kIdx + mod) % mod]
                : 'ÔøΩ';
        }).join('');
    }

    static generateKeyVariants(fragment, targetLen) {
        const variants = new Set();
        for (let len = 1; len <= targetLen; len++) {
            const base = fragment.slice(0, len);
            const repeated = base.repeat(Math.ceil(fragment.length / len)).slice(0, fragment.length);
            if (repeated === fragment) variants.add(base);
        }
        return Array.from(variants);
    }

    static async process(ciphertext, known, alphabet, keyLength, update) {
        const validKeys = new Map();
        const knownLen = known.length;
        const total = ciphertext.length - knownLen;

        for (currentPos = 0; currentPos <= total; currentPos++) {
            if (!isRunning) break;

            const cipherFragment = ciphertext.slice(currentPos, currentPos + knownLen);
            const keyFragment = [...known].map((pChar, i) => {
                const c = cipherFragment[i];
                const pIdx = alphabet.indexOf(pChar);
                const cIdx = alphabet.indexOf(c);
                return (pIdx !== -1 && cIdx !== -1) 
                    ? alphabet[(cIdx - pIdx + alphabet.length) % alphabet.length]
                    : null;
            }).filter(c => c !== null).join('');

            const candidates = this.generateKeyVariants(keyFragment, keyLength);
            for (const key of candidates) {
                if (key.length !== keyLength) continue;

                const decrypted = this.decrypt(ciphertext, key, alphabet);
                const matchPos = decrypted.indexOf(known);
                if (matchPos !== -1) {
                    const entry = validKeys.get(key) || { positions: [], decrypted };
                    entry.positions.push(currentPos);
                    validKeys.set(key, entry);
                }
            }

            await update(currentPos + 1, total);
        }
        return Array.from(validKeys.entries()).map(([k, v]) => ({ key: k, ...v }));
    }
}

async function start() {
    if (isRunning) return;
    isRunning = true;
    document.getElementById('stopBtn').disabled = false;

    const ciphertext = document.getElementById('ciphertext').value.toUpperCase().replace(/[^A-Z]/g, '');
    const known = document.getElementById('knownText').value.toUpperCase().replace(/[^A-Z]/g, '');
    const alphabet = [...new Set(document.getElementById('alphabet').value.toUpperCase().replace(/[^A-Z]/g, ''))].join('');
    const keyLength = parseInt(document.getElementById('keyLength').value);

    if (alphabet.length !== 26) {
        alert("Alphabet must have 26 unique characters!");
        isRunning = false;
        return;
    }

    document.getElementById('results').innerHTML = '';
    const updateProgress = (current, total) => {
        document.getElementById('progress').innerHTML = `Processed: ${current}/${total}`;
        return new Promise(resolve => setTimeout(resolve, 0));
    };

    try {
        const results = await Vigen√®rePro.process(ciphertext, known, alphabet, keyLength, updateProgress);
        displayResults(results, known);
    } finally {
        isRunning = false;
        document.getElementById('stopBtn').disabled = true;
    }
}

function stop() {
    isRunning = false;
}

function displayResults(results, known) {
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = results.map(({ key, decrypted, positions }) => `
        <div class="result">
            <strong>üîë ${key}</strong> (length: ${key.length})<br>
            üìç Positions: ${positions.join(', ')}<br>
            üìú Decrypted: ${decrypted.replace(new RegExp(known, 'gi'), '<span class="match">$&</span>')}
        </div>
        <hr>
    `).join('');
}
</script>
</body>
</html>
